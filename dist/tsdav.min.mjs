import{fetch as e}from"cross-fetch";import t from"debug";import r from"xml-js";import{encode as o}from"base-64";function a(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(o=Object.getOwnPropertySymbols(e);a<o.length;a++)t.indexOf(o[a])<0&&Object.prototype.propertyIsEnumerable.call(e,o[a])&&(r[o[a]]=e[o[a]])}return r}function n(e,t,r,o){return new(r||(r=Promise))((function(a,n){function d(e){try{i(o.next(e))}catch(e){n(e)}}function s(e){try{i(o.throw(e))}catch(e){n(e)}}function i(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}i((o=o.apply(e,t||[])).next())}))}var d;"function"==typeof SuppressedError&&SuppressedError,function(e){e.CALENDAR_SERVER="http://calendarserver.org/ns/",e.CALDAV_APPLE="http://apple.com/ns/ical/",e.CALDAV="urn:ietf:params:xml:ns:caldav",e.CARDDAV="urn:ietf:params:xml:ns:carddav",e.DAV="DAV:"}(d||(d={}));const s={[d.CALDAV]:"xmlns:c",[d.CARDDAV]:"xmlns:card",[d.CALENDAR_SERVER]:"xmlns:cs",[d.CALDAV_APPLE]:"xmlns:ca",[d.DAV]:"xmlns:d"};var i,c;!function(e){e.CALDAV="c",e.CARDDAV="card",e.CALENDAR_SERVER="cs",e.CALDAV_APPLE="ca",e.DAV="d"}(i||(i={})),function(e){e.VEVENT="VEVENT",e.VTODO="VTODO",e.VJOURNAL="VJOURNAL",e.VFREEBUSY="VFREEBUSY",e.VTIMEZONE="VTIMEZONE",e.VALARM="VALARM"}(c||(c={}));const l=e=>{const t=Number(e);if(!Number.isNaN(t))return t;const r=e.toLowerCase();return"true"===r||"false"!==r&&e},u=(e,t)=>{if(!e&&!t)return!0;if(!e||!t)return!1;const r=e.trim(),o=t.trim();if(Math.abs(r.length-o.length)>1)return!1;const a="/"===r.slice(-1)?r.slice(0,-1):r,n="/"===o.slice(-1)?o.slice(0,-1):o;return e.includes(n)||t.includes(a)},h=(e,t)=>{if(!e&&!t)return!0;if(!e||!t)return!1;const r=e.trim(),o=t.trim(),a="/"===r.slice(-1)?r.slice(0,-1):r,n="/"===o.slice(-1)?o.slice(0,-1):o;return e.includes(n)||t.includes(a)},p=e=>e.reduce(((e,t)=>Object.assign(Object.assign({},e),{[s[t]]:t})),{}),v=e=>Object.entries(e).reduce(((e,[t,r])=>r?Object.assign(Object.assign({},e),{[t]:r}):e),{}),f=(e,t)=>t?{[e]:t}:{},g=(e,t)=>e?t&&0!==t.length?Object.fromEntries(Object.entries(e).filter((([e])=>!t.includes(e)))):e:{};var m=Object.freeze({__proto__:null,cleanupFalsy:v,conditionalParam:f,excludeHeaders:g,getDAVAttribute:p,urlContains:h,urlEquals:u});const b=t("tsdav:request"),y=t=>n(void 0,void 0,void 0,(function*(){var o;const{url:a,init:n,convertIncoming:d=!0,parseOutgoing:s=!0}=t,{headers:i={},body:c,namespace:u,method:h,attributes:p}=n,f=d?r.js2xml(Object.assign(Object.assign({_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}}},c),{_attributes:p}),{compact:!0,spaces:2,elementNameFn:e=>u&&!/^.+:.+/.test(e)?`${u}:${e}`:e}):c,g=yield e(a,{headers:Object.assign({"Content-Type":"text/xml;charset=UTF-8"},v(i)),body:f,method:h}),m=yield g.text();if(!g.ok||!(null===(o=g.headers.get("content-type"))||void 0===o?void 0:o.includes("xml"))||!s)return[{href:g.url,ok:g.ok,status:g.status,statusText:g.statusText,raw:m}];const y=r.xml2js(m,{compact:!0,trim:!0,textFn:(e,t)=>{try{const r=t._parent,o=Object.keys(r),a=o[o.length-1],n=r[a];if(n.length>0){n[n.length-1]=l(e)}else r[a]=l(e)}catch(e){b(e.stack)}},elementNameFn:e=>e.replace(/^.+:/,"").replace(/([-_]\w)/g,(e=>e[1].toUpperCase())),attributesFn:e=>{const t=Object.assign({},e);return delete t.xmlns,t},ignoreDeclaration:!0});return(Array.isArray(y.multistatus.response)?y.multistatus.response:[y.multistatus.response]).map((e=>{var t,r;if(!e)return{status:g.status,statusText:g.statusText,ok:g.ok};const o=/^\S+\s(?<status>\d+)\s(?<statusText>.+)$/.exec(e.status);return{raw:y,href:e.href,status:(null==o?void 0:o.groups)?Number.parseInt(null==o?void 0:o.groups.status,10):g.status,statusText:null!==(r=null===(t=null==o?void 0:o.groups)||void 0===t?void 0:t.statusText)&&void 0!==r?r:g.statusText,ok:!e.error,error:e.error,responsedescription:e.responsedescription,props:(Array.isArray(e.propstat)?e.propstat:[e.propstat]).reduce(((e,t)=>Object.assign(Object.assign({},e),null==t?void 0:t.prop)),{})}}))})),A=e=>n(void 0,void 0,void 0,(function*(){const{url:t,props:r,depth:o,headers:a,headersToExclude:n}=e;return y({url:t,init:{method:"PROPFIND",headers:g(v(Object.assign({depth:o},a)),n),namespace:i.DAV,body:{propfind:{_attributes:p([d.CALDAV,d.CALDAV_APPLE,d.CALENDAR_SERVER,d.CARDDAV,d.DAV]),prop:r}}}})})),O=t=>n(void 0,void 0,void 0,(function*(){const{url:r,data:o,headers:a,headersToExclude:n}=t;return e(r,{method:"PUT",body:o,headers:g(a,n)})})),j=t=>n(void 0,void 0,void 0,(function*(){const{url:r,data:o,etag:a,headers:n,headersToExclude:d}=t;return e(r,{method:"PUT",body:o,headers:g(v(Object.assign({"If-Match":a},n)),d)})})),D=t=>n(void 0,void 0,void 0,(function*(){const{url:r,headers:o,etag:a,headersToExclude:n}=t;return e(r,{method:"DELETE",headers:g(v(Object.assign({"If-Match":a},o)),n)})}));var C=Object.freeze({__proto__:null,createObject:O,davRequest:y,deleteObject:D,propfind:A,updateObject:j});function V(e,t){const r=e=>t.every((t=>e[t]));return Array.isArray(e)?e.every((e=>r(e))):r(e)}const E=(e,t)=>t.reduce(((t,r)=>e[r]?t:`${t.length?`${t},`:""}${r.toString()}`),""),T=t("tsdav:collection"),$=e=>n(void 0,void 0,void 0,(function*(){const{url:t,body:r,depth:o,defaultNamespace:a=i.DAV,headers:n,headersToExclude:d}=e,s=yield y({url:t,init:{method:"REPORT",headers:g(v(Object.assign({depth:o},n)),d),namespace:a,body:r}});return 1!==s.length||s[0].raw?s:[]})),w=e=>n(void 0,void 0,void 0,(function*(){const{url:t,props:r,depth:o,headers:a,headersToExclude:n}=e;return y({url:t,init:{method:"MKCOL",headers:g(v(Object.assign({depth:o},a)),n),namespace:i.DAV,body:r?{mkcol:{set:{prop:r}}}:void 0}})})),k=e=>n(void 0,void 0,void 0,(function*(){var t,r,o,a,n;const{collection:d,headers:s,headersToExclude:c}=e;return null!==(n=null===(a=null===(o=null===(r=null===(t=(yield A({url:d.url,props:{[`${i.DAV}:supported-report-set`]:{}},depth:"0",headers:g(s,c)}))[0])||void 0===t?void 0:t.props)||void 0===r?void 0:r.supportedReportSet)||void 0===o?void 0:o.supportedReport)||void 0===a?void 0:a.map((e=>Object.keys(e.report)[0])))&&void 0!==n?n:[]})),U=e=>n(void 0,void 0,void 0,(function*(){var t,r,o;const{collection:a,headers:n,headersToExclude:d}=e,s=(yield A({url:a.url,props:{[`${i.CALENDAR_SERVER}:getctag`]:{}},depth:"0",headers:g(n,d)})).filter((e=>h(a.url,e.href)))[0];if(!s)throw new Error("Collection does not exist on server");return{isDirty:a.ctag!==(null===(t=s.props)||void 0===t?void 0:t.getctag),newCtag:null===(o=null===(r=s.props)||void 0===r?void 0:r.getctag)||void 0===o?void 0:o.toString()}})),_=e=>{const{url:t,props:r,headers:o,syncLevel:a,syncToken:n,headersToExclude:s}=e;return y({url:t,init:{method:"REPORT",namespace:i.DAV,headers:g(Object.assign({},o),s),body:{"sync-collection":{_attributes:p([d.CALDAV,d.CARDDAV,d.DAV]),"sync-level":a,"sync-token":n,[`${i.DAV}:prop`]:r}}}})},R=e=>n(void 0,void 0,void 0,(function*(){var t,r,o,a,n,d,s,c,l,u,p;const{collection:v,method:f,headers:m,headersToExclude:b,account:y,detailedResult:A}=e,O=["accountType","homeUrl"];if(!y||!V(y,O)){if(!y)throw new Error("no account for smartCollectionSync");throw new Error(`account must have ${E(y,O)} before smartCollectionSync`)}const j=null!=f?f:(null===(t=v.reports)||void 0===t?void 0:t.includes("syncCollection"))?"webdav":"basic";if(T(`smart collection sync with type ${y.accountType} and method ${j}`),"webdav"===j){const e=yield _({url:v.url,props:{[`${i.DAV}:getetag`]:{},[`${"caldav"===y.accountType?i.CALDAV:i.CARDDAV}:${"caldav"===y.accountType?"calendar-data":"address-data"}`]:{},[`${i.DAV}:displayname`]:{}},syncLevel:1,syncToken:v.syncToken,headers:g(m,b)}),t=e.filter((e=>{var t;const r="caldav"===y.accountType?".ics":".vcf";return(null===(t=e.href)||void 0===t?void 0:t.slice(-4))===r})),l=t.filter((e=>404!==e.status)).map((e=>e.href)),u=t.filter((e=>404===e.status)).map((e=>e.href)),p=(l.length&&null!==(o=yield null===(r=null==v?void 0:v.objectMultiGet)||void 0===r?void 0:r.call(v,{url:v.url,props:{[`${i.DAV}:getetag`]:{},[`${"caldav"===y.accountType?i.CALDAV:i.CARDDAV}:${"caldav"===y.accountType?"calendar-data":"address-data"}`]:{}},objectUrls:l,depth:"1",headers:g(m,b)}))&&void 0!==o?o:[]).map((e=>{var t,r,o,a,n,d,s,i,c,l;return{url:null!==(t=e.href)&&void 0!==t?t:"",etag:null===(r=e.props)||void 0===r?void 0:r.getetag,data:"caldav"===(null==y?void 0:y.accountType)?null!==(n=null===(a=null===(o=e.props)||void 0===o?void 0:o.calendarData)||void 0===a?void 0:a._cdata)&&void 0!==n?n:null===(d=e.props)||void 0===d?void 0:d.calendarData:null!==(c=null===(i=null===(s=e.props)||void 0===s?void 0:s.addressData)||void 0===i?void 0:i._cdata)&&void 0!==c?c:null===(l=e.props)||void 0===l?void 0:l.addressData}})),f=null!==(a=v.objects)&&void 0!==a?a:[],O=p.filter((e=>f.every((t=>!h(t.url,e.url))))),j=f.reduce(((e,t)=>{const r=p.find((e=>h(e.url,t.url)));return r&&r.etag&&r.etag!==t.etag?[...e,r]:e}),[]),D=u.map((e=>({url:e,etag:""}))),C=f.filter((e=>p.some((t=>h(e.url,t.url)&&t.etag===e.etag))));return Object.assign(Object.assign({},v),{objects:A?{created:O,updated:j,deleted:D}:[...C,...O,...j],syncToken:null!==(c=null===(s=null===(d=null===(n=e[0])||void 0===n?void 0:n.raw)||void 0===d?void 0:d.multistatus)||void 0===s?void 0:s.syncToken)&&void 0!==c?c:v.syncToken})}if("basic"===j){const{isDirty:e,newCtag:t}=yield U({collection:v,headers:g(m,b)}),r=null!==(l=v.objects)&&void 0!==l?l:[],o=null!==(p=yield null===(u=v.fetchObjects)||void 0===u?void 0:u.call(v,{collection:v,headers:g(m,b)}))&&void 0!==p?p:[],a=o.filter((e=>r.every((t=>!h(t.url,e.url))))),n=r.reduce(((e,t)=>{const r=o.find((e=>h(e.url,t.url)));return r&&r.etag&&r.etag!==t.etag?[...e,r]:e}),[]),d=r.filter((e=>o.every((t=>!h(t.url,e.url))))),s=r.filter((e=>o.some((t=>h(e.url,t.url)&&t.etag===e.etag))));if(e)return Object.assign(Object.assign({},v),{objects:A?{created:a,updated:n,deleted:d}:[...s,...a,...n],ctag:t})}return A?Object.assign(Object.assign({},v),{objects:{created:[],updated:[],deleted:[]}}):v}));var S=Object.freeze({__proto__:null,collectionQuery:$,isCollectionDirty:U,makeCollection:w,smartCollectionSync:R,supportedReportSet:k,syncCollection:_});const x=t("tsdav:addressBook"),L=e=>n(void 0,void 0,void 0,(function*(){const{url:t,props:r,filters:o,depth:a,headers:n,headersToExclude:s}=e;return $({url:t,body:{"addressbook-query":{_attributes:p([d.CARDDAV,d.DAV]),[`${i.DAV}:prop`]:r,filter:null!=o?o:{"prop-filter":{_attributes:{name:"FN"}}}}},defaultNamespace:i.CARDDAV,depth:a,headers:g(n,s)})})),N=e=>n(void 0,void 0,void 0,(function*(){const{url:t,props:r,objectUrls:o,depth:a,headers:n}=e;return $({url:t,body:{"addressbook-multiget":{_attributes:p([d.DAV,d.CARDDAV]),[`${i.DAV}:prop`]:r,[`${i.DAV}:href`]:o}},defaultNamespace:i.CARDDAV,depth:a,headers:n})})),P=e=>n(void 0,void 0,void 0,(function*(){const{account:t,headers:r,props:o,headersToExclude:a}=null!=e?e:{},d=["homeUrl","rootUrl"];if(!t||!V(t,d)){if(!t)throw new Error("no account for fetchAddressBooks");throw new Error(`account must have ${E(t,d)} before fetchAddressBooks`)}const s=yield A({url:t.homeUrl,props:null!=o?o:{[`${i.DAV}:displayname`]:{},[`${i.CALENDAR_SERVER}:getctag`]:{},[`${i.DAV}:resourcetype`]:{},[`${i.DAV}:sync-token`]:{}},depth:"1",headers:g(r,a)});return Promise.all(s.filter((e=>{var t,r;return Object.keys(null!==(r=null===(t=e.props)||void 0===t?void 0:t.resourcetype)&&void 0!==r?r:{}).includes("addressbook")})).map((e=>{var r,o,a,n,d,s,i,c,l;const u=null!==(a=null===(o=null===(r=e.props)||void 0===r?void 0:r.displayname)||void 0===o?void 0:o._cdata)&&void 0!==a?a:null===(n=e.props)||void 0===n?void 0:n.displayname;return x(`Found address book named ${"string"==typeof u?u:""},\n             props: ${JSON.stringify(e.props)}`),{url:new URL(null!==(d=e.href)&&void 0!==d?d:"",null!==(s=t.rootUrl)&&void 0!==s?s:"").href,ctag:null===(i=e.props)||void 0===i?void 0:i.getctag,displayName:"string"==typeof u?u:"",resourcetype:Object.keys(null===(c=e.props)||void 0===c?void 0:c.resourcetype),syncToken:null===(l=e.props)||void 0===l?void 0:l.syncToken}})).map((e=>n(void 0,void 0,void 0,(function*(){return Object.assign(Object.assign({},e),{reports:yield k({collection:e,headers:r})})})))))})),H=e=>n(void 0,void 0,void 0,(function*(){const{addressBook:t,headers:r,objectUrls:o,headersToExclude:a,urlFilter:n=(e=>e),useMultiGet:d=!0}=e;x(`Fetching vcards from ${null==t?void 0:t.url}`);const s=["url"];if(!t||!V(t,s)){if(!t)throw new Error("cannot fetchVCards for undefined addressBook");throw new Error(`addressBook must have ${E(t,s)} before fetchVCards`)}const c=(null!=o?o:(yield L({url:t.url,props:{[`${i.DAV}:getetag`]:{}},depth:"1",headers:g(r,a)})).map((e=>{var t;return e.ok&&null!==(t=e.href)&&void 0!==t?t:""}))).map((e=>e.startsWith("http")||!e?e:new URL(e,t.url).href)).filter(n).map((e=>new URL(e).pathname));let l=[];return c.length>0&&(l=d?yield N({url:t.url,props:{[`${i.DAV}:getetag`]:{},[`${i.CARDDAV}:address-data`]:{}},objectUrls:c,depth:"1",headers:g(r,a)}):yield L({url:t.url,props:{[`${i.DAV}:getetag`]:{},[`${i.CARDDAV}:address-data`]:{}},depth:"1",headers:g(r,a)})),l.map((e=>{var r,o,a,n,d,s;return{url:new URL(null!==(r=e.href)&&void 0!==r?r:"",t.url).href,etag:null===(o=e.props)||void 0===o?void 0:o.getetag,data:null!==(d=null===(n=null===(a=e.props)||void 0===a?void 0:a.addressData)||void 0===n?void 0:n._cdata)&&void 0!==d?d:null===(s=e.props)||void 0===s?void 0:s.addressData}}))})),B=e=>n(void 0,void 0,void 0,(function*(){const{addressBook:t,vCardString:r,filename:o,headers:a,headersToExclude:n}=e;return O({url:new URL(o,t.url).href,data:r,headers:g(Object.assign({"content-type":"text/vcard; charset=utf-8","If-None-Match":"*"},a),n)})})),I=e=>n(void 0,void 0,void 0,(function*(){const{vCard:t,headers:r,headersToExclude:o}=e;return j({url:t.url,data:t.data,etag:t.etag,headers:g(Object.assign({"content-type":"text/vcard; charset=utf-8"},r),o)})})),M=e=>n(void 0,void 0,void 0,(function*(){const{vCard:t,headers:r,headersToExclude:o}=e;return D({url:t.url,etag:t.etag,headers:g(r,o)})}));var F=Object.freeze({__proto__:null,addressBookMultiGet:N,addressBookQuery:L,createVCard:B,deleteVCard:M,fetchAddressBooks:P,fetchVCards:H,updateVCard:I});const z=t("tsdav:calendar"),Z=e=>n(void 0,void 0,void 0,(function*(){const{url:t,props:r,filters:o,timezone:a,depth:n,headers:s,headersToExclude:c}=e;return $({url:t,body:{"calendar-query":v({_attributes:p([d.CALDAV,d.CALENDAR_SERVER,d.CALDAV_APPLE,d.DAV]),[`${i.DAV}:prop`]:r,filter:o,timezone:a})},defaultNamespace:i.CALDAV,depth:n,headers:g(s,c)})})),G=e=>n(void 0,void 0,void 0,(function*(){const{url:t,props:r,objectUrls:o,filters:a,timezone:n,depth:s,headers:c,headersToExclude:l}=e;return $({url:t,body:{"calendar-multiget":Object.assign(Object.assign({_attributes:p([d.DAV,d.CALDAV]),[`${i.DAV}:prop`]:r,[`${i.DAV}:href`]:o},f("filter",a)),{timezone:n})},defaultNamespace:i.CALDAV,depth:s,headers:g(c,l)})})),Q=e=>n(void 0,void 0,void 0,(function*(){const{url:t,props:r,depth:o,headers:a,headersToExclude:n}=e;return y({url:t,init:{method:"MKCALENDAR",headers:g(v(Object.assign({depth:o},a)),n),namespace:i.DAV,body:{[`${i.CALDAV}:mkcalendar`]:{_attributes:p([d.DAV,d.CALDAV,d.CALDAV_APPLE]),set:{prop:r}}}}})})),q=e=>n(void 0,void 0,void 0,(function*(){const{headers:t,account:r,props:o,projectedProps:a,headersToExclude:d}=null!=e?e:{},s=["homeUrl","rootUrl"];if(!r||!V(r,s)){if(!r)throw new Error("no account for fetchCalendars");throw new Error(`account must have ${E(r,s)} before fetchCalendars`)}const l=yield A({url:r.homeUrl,props:null!=o?o:{[`${i.CALDAV}:calendar-description`]:{},[`${i.CALDAV}:calendar-timezone`]:{},[`${i.DAV}:displayname`]:{},[`${i.CALDAV_APPLE}:calendar-color`]:{},[`${i.CALENDAR_SERVER}:getctag`]:{},[`${i.DAV}:resourcetype`]:{},[`${i.CALDAV}:supported-calendar-component-set`]:{},[`${i.DAV}:sync-token`]:{}},depth:"1",headers:g(t,d)});return Promise.all(l.filter((e=>{var t,r;return Object.keys(null!==(r=null===(t=e.props)||void 0===t?void 0:t.resourcetype)&&void 0!==r?r:{}).includes("calendar")})).filter((e=>{var t,r,o,a;return(Array.isArray(null===(t=e.props)||void 0===t?void 0:t.supportedCalendarComponentSet.comp)?null===(r=e.props)||void 0===r?void 0:r.supportedCalendarComponentSet.comp.map((e=>e._attributes.name)):[null===(a=null===(o=e.props)||void 0===o?void 0:o.supportedCalendarComponentSet.comp)||void 0===a?void 0:a._attributes.name]||[]).some((e=>Object.values(c).includes(e)))})).map((e=>{var t,o,n,d,s,i,c,l,u,h,p,v,g,m,b,y;const A=null===(t=e.props)||void 0===t?void 0:t.calendarDescription,O=null===(o=e.props)||void 0===o?void 0:o.calendarTimezone;return Object.assign({description:"string"==typeof A?A:"",timezone:"string"==typeof O?O:"",url:new URL(null!==(n=e.href)&&void 0!==n?n:"",null!==(d=r.rootUrl)&&void 0!==d?d:"").href,ctag:null===(s=e.props)||void 0===s?void 0:s.getctag,calendarColor:null===(i=e.props)||void 0===i?void 0:i.calendarColor,displayName:null!==(l=null===(c=e.props)||void 0===c?void 0:c.displayname._cdata)&&void 0!==l?l:null===(u=e.props)||void 0===u?void 0:u.displayname,components:Array.isArray(null===(h=e.props)||void 0===h?void 0:h.supportedCalendarComponentSet.comp)?null===(p=e.props)||void 0===p?void 0:p.supportedCalendarComponentSet.comp.map((e=>e._attributes.name)):[null===(g=null===(v=e.props)||void 0===v?void 0:v.supportedCalendarComponentSet.comp)||void 0===g?void 0:g._attributes.name],resourcetype:Object.keys(null===(m=e.props)||void 0===m?void 0:m.resourcetype),syncToken:null===(b=e.props)||void 0===b?void 0:b.syncToken},f("projectedProps",Object.fromEntries(Object.entries(null!==(y=e.props)&&void 0!==y?y:{}).filter((([e])=>null==a?void 0:a[e])))))})).map((e=>n(void 0,void 0,void 0,(function*(){return Object.assign(Object.assign({},e),{reports:yield k({collection:e,headers:g(t,d)})})})))))})),J=e=>n(void 0,void 0,void 0,(function*(){const{calendar:t,objectUrls:r,filters:o,timeRange:a,headers:n,expand:d,urlFilter:s=(e=>Boolean(null==e?void 0:e.includes(".ics"))),useMultiGet:c=!0,headersToExclude:l}=e;if(a){const e=/^\d{4}(-\d\d(-\d\d(T\d\d:\d\d(:\d\d)?(\.\d+)?(([+-]\d\d:\d\d)|Z)?)?)?)?$/i,t=/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(([+-]\d\d:\d\d)|Z)?$/i;if(!(e.test(a.start)&&e.test(a.end)||t.test(a.start)&&t.test(a.end)))throw new Error("invalid timeRange format, not in ISO8601")}z(`Fetching calendar objects from ${null==t?void 0:t.url}`);const u=["url"];if(!t||!V(t,u)){if(!t)throw new Error("cannot fetchCalendarObjects for undefined calendar");throw new Error(`calendar must have ${E(t,u)} before fetchCalendarObjects`)}const h=null!=o?o:[{"comp-filter":{_attributes:{name:"VCALENDAR"},"comp-filter":Object.assign({_attributes:{name:"VEVENT"}},a?{"time-range":{_attributes:{start:`${new Date(a.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(a.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{})}}],p=(null!=r?r:(yield Z({url:t.url,props:{[`${i.DAV}:getetag`]:Object.assign({},d&&a?{[`${i.CALDAV}:expand`]:{_attributes:{start:`${new Date(a.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(a.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{})},filters:h,depth:"1",headers:g(n,l)})).map((e=>{var t;return null!==(t=e.href)&&void 0!==t?t:""}))).map((e=>e.startsWith("http")||!e?e:new URL(e,t.url).href)).filter(s).map((e=>new URL(e).pathname));let v=[];return p.length>0&&(v=!c||d?yield Z({url:t.url,props:{[`${i.DAV}:getetag`]:{},[`${i.CALDAV}:calendar-data`]:Object.assign({},d&&a?{[`${i.CALDAV}:expand`]:{_attributes:{start:`${new Date(a.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(a.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{})},filters:h,depth:"1",headers:g(n,l)}):yield G({url:t.url,props:{[`${i.DAV}:getetag`]:{},[`${i.CALDAV}:calendar-data`]:Object.assign({},d&&a?{[`${i.CALDAV}:expand`]:{_attributes:{start:`${new Date(a.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(a.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}}:{})},objectUrls:p,depth:"1",headers:g(n,l)})),v.map((e=>{var r,o,a,n,d,s;return{url:new URL(null!==(r=e.href)&&void 0!==r?r:"",t.url).href,etag:`${null===(o=e.props)||void 0===o?void 0:o.getetag}`,data:null!==(d=null===(n=null===(a=e.props)||void 0===a?void 0:a.calendarData)||void 0===n?void 0:n._cdata)&&void 0!==d?d:null===(s=e.props)||void 0===s?void 0:s.calendarData}}))})),K=e=>n(void 0,void 0,void 0,(function*(){const{calendar:t,iCalString:r,filename:o,headers:a,headersToExclude:n}=e;return O({url:new URL(o,t.url).href,data:r,headers:g(Object.assign({"content-type":"text/calendar; charset=utf-8","If-None-Match":"*"},a),n)})})),W=e=>n(void 0,void 0,void 0,(function*(){const{calendarObject:t,headers:r,headersToExclude:o}=e;return j({url:t.url,data:t.data,etag:t.etag,headers:g(Object.assign({"content-type":"text/calendar; charset=utf-8"},r),o)})})),Y=e=>n(void 0,void 0,void 0,(function*(){const{calendarObject:t,headers:r,headersToExclude:o}=e;return D({url:t.url,etag:t.etag,headers:g(r,o)})})),X=e=>n(void 0,void 0,void 0,(function*(){var t;const{oldCalendars:r,account:o,detailedResult:a,headers:d,headersToExclude:s}=e;if(!o)throw new Error("Must have account before syncCalendars");const i=null!==(t=null!=r?r:o.calendars)&&void 0!==t?t:[],c=yield q({account:o,headers:g(d,s)}),l=c.filter((e=>i.every((t=>!h(t.url,e.url)))));z(`new calendars: ${l.map((e=>e.displayName))}`);const u=i.reduce(((e,t)=>{const r=c.find((e=>h(e.url,t.url)));return r&&(r.syncToken&&r.syncToken!==t.syncToken||r.ctag&&r.ctag!==t.ctag)?[...e,r]:e}),[]);z(`updated calendars: ${u.map((e=>e.displayName))}`);const p=yield Promise.all(u.map((e=>n(void 0,void 0,void 0,(function*(){return yield R({collection:Object.assign(Object.assign({},e),{objectMultiGet:G}),method:"webdav",headers:g(d,s),account:o})}))))),v=i.filter((e=>c.every((t=>!h(t.url,e.url)))));z(`deleted calendars: ${v.map((e=>e.displayName))}`);const f=i.filter((e=>c.some((t=>h(t.url,e.url)&&(t.syncToken&&t.syncToken!==e.syncToken||t.ctag&&t.ctag!==e.ctag)))));return a?{created:l,updated:u,deleted:v}:[...f,...l,...p]})),ee=e=>n(void 0,void 0,void 0,(function*(){const{url:t,timeRange:r,depth:o,headers:a,headersToExclude:n}=e;if(!r)throw new Error("timeRange is required");{const e=/^\d{4}(-\d\d(-\d\d(T\d\d:\d\d(:\d\d)?(\.\d+)?(([+-]\d\d:\d\d)|Z)?)?)?)?$/i,t=/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(([+-]\d\d:\d\d)|Z)?$/i;if(!(e.test(r.start)&&e.test(r.end)||t.test(r.start)&&t.test(r.end)))throw new Error("invalid timeRange format, not in ISO8601")}return(yield $({url:t,body:{"free-busy-query":v({_attributes:p([d.CALDAV]),[`${i.CALDAV}:time-range`]:{_attributes:{start:`${new Date(r.start).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`,end:`${new Date(r.end).toISOString().slice(0,19).replace(/[-:.]/g,"")}Z`}}})},defaultNamespace:i.CALDAV,depth:o,headers:g(a,n)}))[0]}));var te=Object.freeze({__proto__:null,calendarMultiGet:G,calendarQuery:Z,createCalendarObject:K,deleteCalendarObject:Y,fetchCalendarObjects:J,fetchCalendars:q,freeBusyQuery:ee,makeCalendar:Q,syncCalendars:X,updateCalendarObject:W});const re=t("tsdav:account"),oe=t=>n(void 0,void 0,void 0,(function*(){var r,o;re("Service discovery...");const{account:a,headers:n,headersToExclude:d}=t,s=new URL(a.serverUrl),i=new URL(`/.well-known/${a.accountType}`,s);i.protocol=null!==(r=s.protocol)&&void 0!==r?r:"http";try{const t=yield e(i.href,{headers:g(n,d),method:"PROPFIND",redirect:"manual"});if(t.status>=300&&t.status<400){const e=t.headers.get("Location");if("string"==typeof e&&e.length){re(`Service discovery redirected to ${e}`);const t=new URL(e,s);return t.hostname===i.hostname&&i.port&&!t.port&&(t.port=i.port),t.protocol=null!==(o=s.protocol)&&void 0!==o?o:"http",t.href}}}catch(e){re(`Service discovery failed: ${e.stack}`)}return s.href})),ae=e=>n(void 0,void 0,void 0,(function*(){var t,r,o,a,n;const{account:d,headers:s,headersToExclude:c}=e,l=["rootUrl"];if(!V(d,l))throw new Error(`account must have ${E(d,l)} before fetchPrincipalUrl`);re(`Fetching principal url from path ${d.rootUrl}`);const[u]=yield A({url:d.rootUrl,props:{[`${i.DAV}:current-user-principal`]:{}},depth:"0",headers:g(s,c)});if(!u.ok&&(re(`Fetch principal url failed: ${u.statusText}`),401===u.status))throw new Error("Invalid credentials");return re(`Fetched principal url ${null===(r=null===(t=u.props)||void 0===t?void 0:t.currentUserPrincipal)||void 0===r?void 0:r.href}`),new URL(null!==(n=null===(a=null===(o=u.props)||void 0===o?void 0:o.currentUserPrincipal)||void 0===a?void 0:a.href)&&void 0!==n?n:"",d.rootUrl).href})),ne=e=>n(void 0,void 0,void 0,(function*(){var t,r;const{account:o,headers:a,headersToExclude:n}=e,d=["principalUrl","rootUrl"];if(!V(o,d))throw new Error(`account must have ${E(o,d)} before fetchHomeUrl`);re(`Fetch home url from ${o.principalUrl}`);const s=(yield A({url:o.principalUrl,props:"caldav"===o.accountType?{[`${i.CALDAV}:calendar-home-set`]:{}}:{[`${i.CARDDAV}:addressbook-home-set`]:{}},depth:"0",headers:g(a,n)})).find((e=>h(o.principalUrl,e.href)));if(!s||!s.ok)throw new Error("cannot find homeUrl");const c=new URL("caldav"===o.accountType?null===(t=null==s?void 0:s.props)||void 0===t?void 0:t.calendarHomeSet.href:null===(r=null==s?void 0:s.props)||void 0===r?void 0:r.addressbookHomeSet.href,o.rootUrl).href;return re(`Fetched home url ${c}`),c})),de=e=>n(void 0,void 0,void 0,(function*(){const{account:t,headers:r,loadCollections:o=!1,loadObjects:a=!1,headersToExclude:d}=e,s=Object.assign({},t);return s.rootUrl=s.rootUrl||(yield oe({account:t,headers:g(r,d)})),s.principalUrl=s.principalUrl||(yield ae({account:s,headers:g(r,d)})),s.homeUrl=s.homeUrl||(yield ne({account:s,headers:g(r,d)})),(o||a)&&("caldav"===t.accountType?s.calendars=yield q({headers:g(r,d),account:s}):"carddav"===t.accountType&&(s.addressBooks=yield P({headers:g(r,d),account:s}))),a&&("caldav"===t.accountType&&s.calendars?s.calendars=yield Promise.all(s.calendars.map((e=>n(void 0,void 0,void 0,(function*(){return Object.assign(Object.assign({},e),{objects:yield J({calendar:e,headers:g(r,d)})})}))))):"carddav"===t.accountType&&s.addressBooks&&(s.addressBooks=yield Promise.all(s.addressBooks.map((e=>n(void 0,void 0,void 0,(function*(){return Object.assign(Object.assign({},e),{objects:yield H({addressBook:e,headers:g(r,d)})})}))))))),s}));var se=Object.freeze({__proto__:null,createAccount:de,fetchHomeUrl:ne,fetchPrincipalUrl:ae,serviceDiscovery:oe});const ie=t("tsdav:authHelper"),ce=(e,t)=>(...r)=>e(Object.assign(Object.assign({},t),r[0])),le=e=>(ie(`Basic auth token generated: ${o(`${e.username}:${e.password}`)}`),{authorization:`Basic ${o(`${e.username}:${e.password}`)}`}),ue=t=>n(void 0,void 0,void 0,(function*(){const r=["authorizationCode","redirectUrl","clientId","clientSecret","tokenUrl"];if(!V(t,r))throw new Error(`Oauth credentials missing: ${E(t,r)}`);const o=new URLSearchParams({grant_type:"authorization_code",code:t.authorizationCode,redirect_uri:t.redirectUrl,client_id:t.clientId,client_secret:t.clientSecret});ie(t.tokenUrl),ie(o.toString());const a=yield e(t.tokenUrl,{method:"POST",body:o.toString(),headers:{"content-length":`${o.toString().length}`,"content-type":"application/x-www-form-urlencoded"}});if(a.ok){return yield a.json()}return ie(`Fetch Oauth tokens failed: ${yield a.text()}`),{}})),he=t=>n(void 0,void 0,void 0,(function*(){const r=["refreshToken","clientId","clientSecret","tokenUrl"];if(!V(t,r))throw new Error(`Oauth credentials missing: ${E(t,r)}`);const o=new URLSearchParams({client_id:t.clientId,client_secret:t.clientSecret,refresh_token:t.refreshToken,grant_type:"refresh_token"}),a=yield e(t.tokenUrl,{method:"POST",body:o.toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(a.ok){return yield a.json()}return ie(`Refresh access token failed: ${yield a.text()}`),{}})),pe=e=>n(void 0,void 0,void 0,(function*(){var t;ie("Fetching oauth headers");let r={};return e.refreshToken?(e.refreshToken&&!e.accessToken||Date.now()>(null!==(t=e.expiration)&&void 0!==t?t:0))&&(r=yield he(e)):r=yield ue(e),ie(`Oauth tokens fetched: ${r.access_token}`),{tokens:r,headers:{authorization:`Bearer ${r.access_token}`}}}));var ve=Object.freeze({__proto__:null,defaultParam:ce,fetchOauthTokens:ue,getBasicAuthHeaders:le,getOauthHeaders:pe,refreshAccessToken:he});const fe=e=>n(void 0,void 0,void 0,(function*(){var t;const{serverUrl:r,credentials:o,authMethod:d,defaultAccountType:s,authFunction:i,rootUrl:c,principalUrl:l,homeUrl:u}=e;let h={};switch(d){case"Basic":h=le(o);break;case"Oauth":h=(yield pe(o)).headers;break;case"Digest":h={Authorization:`Digest ${o.digestString}`};break;case"Custom":h=null!==(t=yield null==i?void 0:i(o))&&void 0!==t?t:{};break;default:throw new Error("Invalid auth method")}const p=s?yield de({account:{serverUrl:r,credentials:o,accountType:s,rootUrl:c,principalUrl:l,homeUrl:u},headers:h}):void 0,v=ce(O,{url:r,headers:h}),f=ce(j,{headers:h,url:r}),g=ce(D,{headers:h,url:r}),m=ce(A,{headers:h}),b=ce($,{headers:h}),C=ce(w,{headers:h}),V=ce(_,{headers:h}),E=ce(k,{headers:h}),T=ce(U,{headers:h}),S=ce(R,{headers:h,account:p}),x=ce(Z,{headers:h}),F=ce(G,{headers:h}),z=ce(Q,{headers:h}),ee=ce(q,{headers:h,account:p}),te=ce(J,{headers:h}),re=ce(K,{headers:h}),oe=ce(W,{headers:h}),ae=ce(Y,{headers:h}),ne=ce(X,{account:p,headers:h}),se=ce(L,{headers:h}),ie=ce(N,{headers:h});return{davRequest:e=>n(void 0,void 0,void 0,(function*(){const{init:t}=e,r=a(e,["init"]),{headers:o}=t,n=a(t,["headers"]);return y(Object.assign(Object.assign({},r),{init:Object.assign(Object.assign({},n),{headers:Object.assign(Object.assign({},h),o)})}))})),propfind:m,createAccount:e=>n(void 0,void 0,void 0,(function*(){const{account:t,headers:a,loadCollections:n,loadObjects:d}=e;return de({account:Object.assign({serverUrl:r,credentials:o},t),headers:Object.assign(Object.assign({},h),a),loadCollections:n,loadObjects:d})})),createObject:v,updateObject:f,deleteObject:g,calendarQuery:x,addressBookQuery:se,collectionQuery:b,makeCollection:C,calendarMultiGet:F,makeCalendar:z,syncCollection:V,supportedReportSet:E,isCollectionDirty:T,smartCollectionSync:S,fetchCalendars:ee,fetchCalendarObjects:te,createCalendarObject:re,updateCalendarObject:oe,deleteCalendarObject:ae,syncCalendars:ne,fetchAddressBooks:ce(P,{account:p,headers:h}),addressBookMultiGet:ie,fetchVCards:ce(H,{headers:h}),createVCard:ce(B,{headers:h}),updateVCard:ce(I,{headers:h}),deleteVCard:ce(M,{headers:h}),defaultAccount:p}}));class ge{constructor(e){var t,r;this.serverUrl=e.serverUrl,this.credentials=e.credentials,this.authMethod=null!==(t=e.authMethod)&&void 0!==t?t:"Basic",this.accountType=null!==(r=e.defaultAccountType)&&void 0!==r?r:"caldav"}login(){var e;return n(this,void 0,void 0,(function*(){switch(this.authMethod){case"Basic":this.authHeaders=le(this.credentials);break;case"Oauth":this.authHeaders=(yield pe(this.credentials)).headers;break;case"Digest":this.authHeaders={Authorization:`Digest ${this.credentials.digestString}`};break;case"Custom":this.authHeaders=yield null===(e=this.authFunction)||void 0===e?void 0:e.call(this,this.credentials);break;default:throw new Error("Invalid auth method")}this.account=this.accountType?yield de({account:{serverUrl:this.serverUrl,credentials:this.credentials,accountType:this.accountType},headers:this.authHeaders}):void 0}))}davRequest(e){return n(this,void 0,void 0,(function*(){const{init:t}=e,r=a(e,["init"]),{headers:o}=t,n=a(t,["headers"]);return y(Object.assign(Object.assign({},r),{init:Object.assign(Object.assign({},n),{headers:Object.assign(Object.assign({},this.authHeaders),o)})}))}))}createObject(...e){return n(this,void 0,void 0,(function*(){return ce(O,{url:this.serverUrl,headers:this.authHeaders})(e[0])}))}updateObject(...e){return n(this,void 0,void 0,(function*(){return ce(j,{headers:this.authHeaders,url:this.serverUrl})(e[0])}))}deleteObject(...e){return n(this,void 0,void 0,(function*(){return ce(D,{headers:this.authHeaders,url:this.serverUrl})(e[0])}))}propfind(...e){return n(this,void 0,void 0,(function*(){return ce(A,{headers:this.authHeaders})(e[0])}))}createAccount(e){return n(this,void 0,void 0,(function*(){const{account:t,headers:r,loadCollections:o,loadObjects:a}=e;return de({account:Object.assign({serverUrl:this.serverUrl,credentials:this.credentials},t),headers:Object.assign(Object.assign({},this.authHeaders),r),loadCollections:o,loadObjects:a})}))}collectionQuery(...e){return n(this,void 0,void 0,(function*(){return ce($,{headers:this.authHeaders})(e[0])}))}makeCollection(...e){return n(this,void 0,void 0,(function*(){return ce(w,{headers:this.authHeaders})(e[0])}))}syncCollection(...e){return n(this,void 0,void 0,(function*(){return ce(_,{headers:this.authHeaders})(e[0])}))}supportedReportSet(...e){return n(this,void 0,void 0,(function*(){return ce(k,{headers:this.authHeaders})(e[0])}))}isCollectionDirty(...e){return n(this,void 0,void 0,(function*(){return ce(U,{headers:this.authHeaders})(e[0])}))}smartCollectionSync(...e){return n(this,void 0,void 0,(function*(){return ce(R,{headers:this.authHeaders,account:this.account})(e[0])}))}calendarQuery(...e){return n(this,void 0,void 0,(function*(){return ce(Z,{headers:this.authHeaders})(e[0])}))}makeCalendar(...e){return n(this,void 0,void 0,(function*(){return ce(Q,{headers:this.authHeaders})(e[0])}))}calendarMultiGet(...e){return n(this,void 0,void 0,(function*(){return ce(G,{headers:this.authHeaders})(e[0])}))}fetchCalendars(...e){return n(this,void 0,void 0,(function*(){return ce(q,{headers:this.authHeaders,account:this.account})(null==e?void 0:e[0])}))}fetchCalendarObjects(...e){return n(this,void 0,void 0,(function*(){return ce(J,{headers:this.authHeaders})(e[0])}))}createCalendarObject(...e){return n(this,void 0,void 0,(function*(){return ce(K,{headers:this.authHeaders})(e[0])}))}updateCalendarObject(...e){return n(this,void 0,void 0,(function*(){return ce(W,{headers:this.authHeaders})(e[0])}))}deleteCalendarObject(...e){return n(this,void 0,void 0,(function*(){return ce(Y,{headers:this.authHeaders})(e[0])}))}syncCalendars(...e){return n(this,void 0,void 0,(function*(){return ce(X,{headers:this.authHeaders,account:this.account})(e[0])}))}addressBookQuery(...e){return n(this,void 0,void 0,(function*(){return ce(L,{headers:this.authHeaders})(e[0])}))}addressBookMultiGet(...e){return n(this,void 0,void 0,(function*(){return ce(N,{headers:this.authHeaders})(e[0])}))}fetchAddressBooks(...e){return n(this,void 0,void 0,(function*(){return ce(P,{headers:this.authHeaders,account:this.account})(null==e?void 0:e[0])}))}fetchVCards(...e){return n(this,void 0,void 0,(function*(){return ce(H,{headers:this.authHeaders})(e[0])}))}createVCard(...e){return n(this,void 0,void 0,(function*(){return ce(B,{headers:this.authHeaders})(e[0])}))}updateVCard(...e){return n(this,void 0,void 0,(function*(){return ce(I,{headers:this.authHeaders})(e[0])}))}deleteVCard(...e){return n(this,void 0,void 0,(function*(){return ce(M,{headers:this.authHeaders})(e[0])}))}}var me=Object.freeze({__proto__:null,DAVClient:ge,createDAVClient:fe}),be=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({DAVNamespace:d,DAVNamespaceShort:i,DAVAttributeMap:s},me),C),S),se),F),te),ve),m);export{s as DAVAttributeMap,ge as DAVClient,d as DAVNamespace,i as DAVNamespaceShort,L as addressBookQuery,G as calendarMultiGet,Z as calendarQuery,v as cleanupFalsy,$ as collectionQuery,de as createAccount,K as createCalendarObject,fe as createDAVClient,O as createObject,B as createVCard,y as davRequest,be as default,Y as deleteCalendarObject,D as deleteObject,M as deleteVCard,P as fetchAddressBooks,J as fetchCalendarObjects,q as fetchCalendars,ue as fetchOauthTokens,H as fetchVCards,ee as freeBusyQuery,le as getBasicAuthHeaders,p as getDAVAttribute,pe as getOauthHeaders,U as isCollectionDirty,Q as makeCalendar,A as propfind,he as refreshAccessToken,R as smartCollectionSync,k as supportedReportSet,X as syncCalendars,_ as syncCollection,W as updateCalendarObject,j as updateObject,I as updateVCard,h as urlContains,u as urlEquals};
